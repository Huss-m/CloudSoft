name: Deploy CloudSoft via Bastion Host

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Publish CloudSoft
      run: dotnet publish -c Release -o publish

    - name: Setup SSH key for Bastion
      run: |
        echo "${{ secrets.BASTION_KEY }}" > bastion_key.pem
        chmod 600 bastion_key.pem

    - name: Start SSH tunnel from GitHub runner to App Server via Bastion
      run: |
        ssh -o StrictHostKeyChecking=no -i bastion_key.pem -N -f -L 2222:10.0.0.5:22 azureuser@${{ secrets.BASTION_HOST }}
        sleep 5

    - name: Copy CloudSoft app to AppServer
      run: |
        scp -o StrictHostKeyChecking=no -P 2222 -r ./publish/* azureuser@localhost:~/cloudsoft/

    - name: Restart CloudSoft app on AppServer
      run: |
        ssh -o StrictHostKeyChecking=no -p 2222 azureuser@localhost "sudo systemctl restart cloudsoft"
